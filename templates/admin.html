{% extends "base.html" %}

{% block content %}
<div class="admin-header">
    <h1>Admin Panel</h1>
    <div class="admin-header-actions">
        <button id="clubStatusToggle"
            class="club-status-button {{ 'active' if club_state.is_active else 'inactive' }}"
            data-status="{{ 'deactivate' if club_state.is_active else 'activate' }}"
            onclick="confirmToggleStatus()">
            {% if club_state.is_active %}
            Deactivate Club
            {% else %}
            Activate Club
            {% endif %}
        </button>
        <a href="{{ url_for('home') }}" class="nav-button">Back to Home</a>
    </div>
</div>

<div class="admin-section">
    <div class="section-card">
        <h2 class="timer-title">Court Timer</h2>
        
        <div id="timer" class="admin-timer-display">15:00</div>
        
        <div class="timer-controls">
            <div class="timer-duration-control">
                <label for="timerDuration">Set Time (minutes):</label>
                <div class="timer-input-group">
                    <input type="number" id="timerDuration" min="0.5" max="60" value="15" step="0.1" class="timer-input">
                    <button onclick="setDuration()" class="timer-set-button">Set</button>
                </div>
            </div>
            
            <div class="timer-buttons">
                <button onclick="startTimer()" class="timer-control-button start-button">Start</button>
                <button onclick="pauseTimer()" class="timer-control-button stop-button">Pause</button>
                <button onclick="resetTimer()" class="timer-control-button reset-button">Reset</button>
            </div>
        </div>
    </div>
</div>

<div class="admin-section">
    <div class="section-card">
        <h2 class="court-management-title">Court Management</h2>
        
        <div class="courts-admin-grid">
            {% for court in courts %}
            <div class="court-admin-card">
                <h3>{{ court.name }}</h3>
                
                <div class="court-admin-info">
                    <div class="court-admin-players">
                        <h4>Current Players</h4>
                        <div class="player-list">
                            {% if court.players %}
                                {% for player in court.players %}
                                    <div class="player-item">{{ player.username }}</div>
                                {% endfor %}
                            {% else %}
                                <div class="empty-admin-message">No players</div>
                            {% endif %}
                        </div>
                    </div>
                    
                    <div class="court-admin-queue">
                        <h4>Queue</h4>
                        <div class="queue-list">
                            {% if court.queue %}
                                {% for entry in court.queue | sort(attribute='position') %}
                                    <div class="queue-item">
                                        <span class="queue-number">{{ entry.position }}</span>
                                        {{ entry.user.username }}
                                    </div>
                                {% endfor %}
                            {% else %}
                                <div class="empty-admin-message">No queue</div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
        
        <div class="admin-actions">
            <button onclick="clearCourts()" class="danger-button clear-courts-button">Clear All Courts</button>
        </div>
    </div>
</div>

<script>
  let timerInterval;

  function formatTime(seconds) {
    const mins = Math.floor(seconds / 60);
    const secs = Math.round(seconds % 60);
    return `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
  }

  async function updateTimerDisplay() {
    try {
      const response = await fetch('/timer/status');
      const data = await response.json();
      document.getElementById('timer').textContent = formatTime(data.remaining);

      if (!data.running && timerInterval && data.remaining <= 0) {
        clearInterval(timerInterval);
        timerInterval = null;
      }
    } catch (error) {
      console.error('Error updating timer:', error);
    }
  }

  async function setDuration() {
    const minutes = parseFloat(document.getElementById('timerDuration').value);
    if (isNaN(minutes) || minutes < 0 || minutes > 60) {
      alert('Please enter a valid time between 0.5 and 60 minutes');
      return;
    }

    try {
      const response = await fetch('/timer/set-duration', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ minutes: minutes })
      });
      if (response.ok) {
        const data = await response.json();
        document.getElementById('timer').textContent = formatTime(data.duration);
      } else {
        alert('Failed to set duration');
      }
    } catch (error) {
      console.error('Error setting duration:', error);
      alert('Failed to set duration');
    }
  }

  async function startTimer() {
    try {
      const response = await fetch('/timer/start', { method: 'POST' });
      if (response.ok) {
        if (!timerInterval) {
          timerInterval = setInterval(updateTimerDisplay, 1000);
        }
        updateTimerDisplay();
      }
    } catch (error) {
      console.error('Error starting timer:', error);
    }
  }

  async function pauseTimer() {
    try {
      const response = await fetch('/timer/stop', { 
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        }
      });
      if (response.ok) {
        updateTimerDisplay();
      }
    } catch (error) {
      console.error('Error pausing timer:', error);
    }
  }

  async function resetTimer() {
    try {
      const response = await fetch('/timer/reset', { method: 'POST' });
      if (response.ok) {
        updateTimerDisplay();
      }
    } catch (error) {
      console.error('Error resetting timer:', error);
    }
  }

  async function clearCourts() {
    if (!confirm('Are you sure you want to clear all courts? This will remove all players.')) {
      return;
    }
    try {
      const response = await fetch('/clear-courts', { method: 'POST' });
      if (response.ok) {
        location.reload();
      } else {
        alert('Failed to clear courts');
      }
    } catch (error) {
      console.error('Error clearing courts:', error);
      alert('Failed to clear courts');
    }
  }

  async function updateClubStatus() {
    try {
      const response = await fetch('/club-status');
      const data = await response.json();

      const button = document.getElementById('clubStatusToggle');

      button.textContent = data.is_active ? 'Deactivate Club' : 'Activate Club';
      button.className = `club-status-button ${data.is_active ? 'active' : 'inactive'}`;
    } catch (error) {
      console.error('Error fetching club status:', error);
    }
  }

  async function toggleClubStatus() {
    try {
      const response = await fetch('/toggle-club-status', { method: 'POST' });
      if (response.ok) {
        const data = await response.json();
        updateClubStatus();
        alert(data.is_active ? 'Club is now active.' : 'Club is now inactive.');
      }
    } catch (error) {
      console.error('Error toggling club status:', error);
    }
  }

  function confirmToggleStatus() {
    const button = document.getElementById('clubStatusToggle');
    const isActive = button.getAttribute('data-status') === 'deactivate';
    const message = isActive
      ? 'Are you sure you want to deactivate the club?'
      : 'Are you sure you want to activate the club?';
    if (confirm(message)) {
      toggleClubStatus();
    }
  }

  updateTimerDisplay();
  setInterval(updateTimerDisplay, 1000);
  updateClubStatus();
  setInterval(updateClubStatus, 30000);
</script>
{% endblock %}
